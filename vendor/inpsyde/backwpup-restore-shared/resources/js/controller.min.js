window.BWU=window.BWU||{},window.BWU.Restore=window.BWU.Restore||{},window.BWU.Restore.Factory=window.BWU.Restore.Factory||{},((h,p,n,i)=>{function r(t,e){var n=h.Restore.FactoryDatabase(this.url,this.nonce,JSON.stringify({dbhost:document.querySelector("#db_host").value.trim(),dbname:document.querySelector("#db_name").value.trim(),dbuser:document.querySelector("#db_user").value.trim(),dbpassword:document.querySelector("#db_pw").value.trim(),dbcharset:document.querySelector("#db_charset").value.trim()}));t?p.isFunction(e)&&n.saveConnectionSettings(e):n.testConnection()}function t(t){this.decrypter.needDecryption(t.state)}function s(t){return t.preventDefault(),h.Restore.Functions.loadNextStep(parseInt(t.currentTarget.getAttribute("data-next-step"),10),this.nonce),this}function e(){n("#submit_decrypt_key").on("click",function(){this.decrypter.decrypt({backwpup_action_nonce:this.nonce,encrypted_file_path:this.urlParser("?restore_file")})}.bind(this)),n("body").on(this.ACTION_UPLOAD_SUCCESS,function(){n(".restore-progress-container .progressbar").fadeIn(function(){this.decompresser.decompress()}.bind(this))}.bind(this)),this.downloader&&(n("body").on(this.downloader.ACTION_DOWNLOAD_REQUIRE_DECRYPTION,t.bind(this)),n("body").on(this.downloader.ACTION_DOWNLOAD_SUCCESS,this.decompresser.decompress)),n("body").on(this.decrypter.ACTION_DECRYPTION_SUCCESS,this.decompresser.decompress),n("body").on(this.decompresser.ACTION_DECOMPRESS_FAILED,t.bind(this)),n("body").on(this.decompresser.ACTION_DECOMPRESS_SUCCESS,function(){h.Restore.Functions.loadNextStep(2,this.nonce)}.bind(this))}var m={step1:function(){return this.downloader&&function(){if(!this.urlParser("?trigger_download"))return!1;n(this.uploadElement).hide(),n("#upload_progress").text(i.downloadingArchive),n(".restore-progress-container .progressbar").fadeIn(),this.downloader.download()}.call(this),function(){return this.uploader=new this.uploader.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:"plupload-browse-button",drop_element:"drag-drop-area",multi_selection:!1,url:this.url+"?action=upload&backwpup_action_nonce="+this.nonce,chunk_size:"2mb",filters:{max_file_size:"0",mime_types:[{title:"Zip files",extensions:"zip,tar,tar.gz,tar.bz2,sql,sql.gz"}]},flash_swf_url:"components/moxie/bin/flash/Moxie.swf",silverlight_xap_url:"components/moxie/bin/silverlight/Moxie.xap",id:"restore",init:{FilesAdded:function(){n(this.uploadElement).hide(),this.uploader.start()}.bind(this),UploadProgress:function(t,e){n("#upload_progress").text(i.uploadingArchive+e.percent+"%")},FileUploaded:function(t,e){-1===e.name.indexOf(".sql")&&n("body").trigger(this.ACTION_UPLOAD_SUCCESS,t,e)}.bind(this),Error:function(t,e){h.Functions.printMessageError(e.message,n("#restore_step")),n("body").trigger(this.ACTION_UPLOAD_FAILED,t,e)}}}),this.uploader.init(),this}.call(this),n(this.uploadElement).on("dragover",function(){n(this.uploadElement).addClass("drag-drop-active")}.bind(this)).on("dragleave",function(){n(this.uploadElement).removeClass("drag-drop-active")}.bind(this)).on("drop",function(){n(this.uploadElement).removeClass("drag-drop-active")}.bind(this)),this},step2:function(){return n(".restore-select-strategy").on("click",function(t){t.preventDefault(),this.strategy.save(t.currentTarget.getAttribute("data-strategy"),function(){s.call(this,t)})}.bind(this)),this},step3:function(){var e=this;return n("#db_edit_btn").on("click",function(t){t.preventDefault(),n("#db-settings-form").find("input").removeAttr("readonly"),n("#db_host").focus()}),n("#db_test_btn").on("click",function(t){t.preventDefault(),r.call(e,!1)}),n("#db_form_continue_btn").on("click",function(t){t.preventDefault(),r.call(e,!0,function(){s.call(e,t)})}),this},step4:function(){return n("#do-migrate").on("change",function(e){this.migrate.retrieve(function(t){1==e.currentTarget.checked?(n("#migration-old-url").val(t.data.message),n("#migration-settings-container").removeClass("hidden")):n("#migration-settings-container").addClass("hidden")})}.bind(this)),n("#migration-form-continue-btn").on("click",function(e){e.preventDefault(),n("#do-migrate").is(":checked")?this.migrate.save(n("#migration-old-url").val(),n("#migration-new-url").val(),function(t){!0===t.success?s.call(this,e):h.Functions.printMessageError(t.data.message,n("#restore_step"))}):s.call(this,e)}.bind(this)),this},step5:function(){return n("#start-restore").on("click",function(t){var e=this;t.preventDefault(),this.strategy.retrieve(function(t){"complete restore"===t.data.message?e.filesrestore.init().restore():"db only restore"===t.data.message&&e.databaserestore.init().restore()})}.bind(this)),this},init:function(){return e.call(this),this},construct:function(t,e,n,i,r,s,o,a,d,c,l,u){return p.bindAll(this,"step1","step2","step3","step4","step5","init"),this.url=t,this.nonce=e,this.urlParser=n,this.uploadElement=r,this.uploader=i,this.strategy=s,this.databaserestore=o,this.filesrestore=a,this.decompresser=d,this.downloader=c,this.decrypter=l,this.migrate=u,this}};h.Restore.FactoryController=function(t,e,n,i,r,s,o,a,d,c,l,u){return Object.create(m,{ACTION_UPLOAD_SUCCESS:h.Functions.makeConstant("backwpup.upload_success"),ACTION_UPLOAD_FAILED:h.Functions.makeConstant("backwpup.upload_error")}).construct(t,e,n,i,r,s,o,a,d,c,l,u)}})(window.BWU,window._,window.jQuery,window.backwpupRestoreLocalized);