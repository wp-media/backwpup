!function(e,t,i,a,r){function n(e){return{value:e,writable:!1,configurable:!1,enumerable:!1}}function s(){return document.querySelector("#backwpupajaxnonce").value}function c(e){var t=document.querySelector("#asymmetric_key_generation_waiting");t&&(t.style.display=e)}function o(){var e=document.querySelector("#bwu_encrypt_notice");e&&e.remove()}function y(e,t,i){o(),i&&i.insertAdjacentHTML("beforebegin",'<div id="bwu_encrypt_notice" class="notice notice-'+t+'"><p>'+e+"</p></div>")}var l={generateSymmetricKey:function(e){var i,r,n;this.disableSaveSettings(),e.preventDefault(),e.stopPropagation(),n={action:"encrypt_key_handler",task:"generateSymmetricKey",_ajax_nonce:s()},i=function(e){var i=e.data;e.success?(t(this.symmetricKeyGenerator).hide(),t(this.symmetricKeyDownloader).show(),this.symmetricKeyField.value=i.key,this.symmetricKey.innerText=i.key,this.symmetricKeyDownloader.setAttribute("href","data:application/octet-stream;charset=utf-16le;base64,"+btoa(i.key)),y(i.message,"success",document.querySelector(".nav-tab-wrapper"))):y(i.message,"error",document.querySelector(".nav-tab-wrapper"))}.bind(this),r=function(e,t,i){y(i,"error",document.querySelector(".nav-tab-wrapper"))}.bind(this),t.post(a,n,i).fail(r)},generateAsymmetricKey:function(e){var i,r,n;this.disableSaveSettings(),e.preventDefault(),c("block"),i={action:"encrypt_key_handler",task:"generateAsymmetricKeyPair",_ajax_nonce:s()},r=function(e){var t,i,a=e.data,r=a.keys.publicKey,n=a.keys.privateKey;this.generatedKeyContainer&&(e.success?(t=this.generatedKeyContainer.querySelector("#asymmetric_generated_public_key_downloader"),i=this.generatedKeyContainer.querySelector("#asymmetric_generated_private_key_downloader"),t&&i&&(this.generatedKeyContainer.querySelector(".bwu-generated-key__public .bwu-the-key").innerText=r,this.generatedKeyContainer.querySelector(".bwu-generated-key__private .bwu-the-key").innerText=n,t.setAttribute("href","data:text/plain;base64,"+btoa(r)),i.setAttribute("href","data:text/plain;base64,"+btoa(n)),c("none"),this.asymmetricModal.style.display="block",y(a.message,"success",this.asymmetricModal))):y(a.message,"error",this.asymmetricModal))}.bind(this),n=function(e,t,i){y(i,"error",this.asymmetricModal)}.bind(this),t.post(a,i,r).fail(n)},asymmetricPublicKeyValueToField:function(e){var t=this.generatedKeyContainer.querySelector(".bwu-generated-key__public .bwu-the-key").innerText;e.preventDefault(),e.stopImmediatePropagation(),this.keyHasBeenDownloaded?(this.asymmetricPublicKeyField.setAttribute("value",t),this.asymmetricPublicKey.innerHTML=t,i(),this.enableSaveSettings()):alert(r.mustDownloadPrivateKey)},validateAsymmetricKeysModal:function(e){e.preventDefault(),o(),this.asymmetricPublicKeyField.value||y(r.publicKeyMissed,"warning",this.asymmetricValidateModal)},validateAsymmetricKey:function(){var e,i,n;if(!this.asymmetricPrivateKeyField.value)return alert(r.privateKeyMissed),!1;e={action:"encrypt_key_handler",task:"validateAsymmetricKeyPair",publickey:this.asymmetricPublicKeyField.value,privatekey:this.asymmetricPrivateKeyField.value,_ajax_nonce:s()},i=function(e){var t;t=e.data,e.success||y(t.message,"error",this.asymmetricValidateModal),t.valid?y(r.validPublicKey,"success",this.asymmetricValidateModal):y(r.invalidPublicKey,"error",this.asymmetricValidateModal)}.bind(this),n=function(e,t,i){y(i,"error",this.asymmetricValidateModal)},t.post(a,e,i).fail(n)},cleanOnThickBoxClosing:function(){this.asymmetricModal.style.display="none",this.asymmetricPrivateKeyField.value=""},toggleEncryptionType:function(e){var i=e.target.dataset.encryptionType;t(this.tab.querySelector("#encryption")).val(i);var a=null,r=null;if(e.target.checked){switch(a=i){case this.TYPE_SYMMETRIC:r="asymmetric";break;case this.TYPE_ASYMMETRIC:r="symmetric"}t(this.tab.querySelector("#bwu_encryption_"+r)).prop("checked",!1),t(this.tab.querySelector("#"+a+"_key_container")).show(),t(this.tab.querySelector("#"+r+"_key_container")).hide()}else t(e.target).prop("checked",!0)},currentOption:function(){return e.filter(this.encryptionKeyOptions,(function(e){return e.checked}))[0]},ensureDownloadedKeys:function(e){var i;if(t(this.tab).is(":visible")){if(!this.keyHasBeenDownloaded){switch(e.preventDefault(),this.currentOption().value){case this.TYPE_SYMMETRIC:i=r.mustDownloadSymmetricKey;break;case this.TYPE_ASYMMETRIC:i=r.mustDownloadPrivateKey}return y(i,"error",document.querySelector(".nav-tab-wrapper")),void this.disableSaveSettings()}this.enableSaveSettings()}},enableSaveSettings:function(){this.keyHasBeenDownloaded=!0,t("#encryption_submit").prop("disabled",!1),t('input[name="encryption_activated"]').prop("disabled",!1)},disableSaveSettings:function(){this.keyHasBeenDownloaded=!1,t("#encryption_submit").prop("disabled",!0),t('input[name="encryption_activated"]').prop("disabled",!0)},construct:function(){var t,i;return e.bindAll(this,"toggleEncryptionType","addListeners","generateSymmetricKey","generateAsymmetricKey","asymmetricPublicKeyValueToField","validateAsymmetricKeysModal","cleanOnThickBoxClosing","validateAsymmetricKey","ensureDownloadedKeys","enableSaveSettings","disableSaveSettings","init"),!!(t=document.querySelector("#sidebar-settings-encryption"))&&(!!(i=t.querySelectorAll(".js-backwpup-bwu-encryption-input")).length&&(this.form=document.querySelector("#encryptionsettingsform"),this.tab=t,this.encryptionKeyOptions=i,this.symmetricKey=this.tab.querySelector("#symmetric_key_code"),this.symmetricKeyField=this.tab.querySelector("#symmetric_key"),this.symmetricKeyDownloader=this.tab.querySelector("#symmetric_key_downloader"),this.asymmetricPublicKey=this.tab.querySelector("#asymmetric_public_key_code"),this.asymmetricPublicKeyField=this.tab.querySelector("#asymmetric_public_key"),this.symmetricKeyGenerator=this.tab.querySelector("#symmetric_key_generator"),this.asymmetricKeyGenerator=this.tab.querySelector("#asymmetric_key_pair_generator"),this.asymmetricKeyOpenValidateModal=this.tab.querySelector("#asymmetric_key_open_validate_modal"),this.asymmetricModal=document.querySelector("#asymmetric_generated_key_modal"),this.generatedKeyContainer=this.asymmetricModal.querySelector(".bwu-generated-key"),this.privateKeyDownloader=this.asymmetricModal.querySelector("#asymmetric_generated_private_key_downloader"),this.asymmetricKeySelector=this.asymmetricModal.querySelector("#asymmetric_keys_selector"),this.keyHasBeenDownloaded=!0,this.asymmetricValidateModal=document.querySelector("#asymmetric_key_pair_validate"),this.asymmetricKeyDoValidation=this.asymmetricValidateModal.querySelector("#asymmetric_key_pair_do_validation"),this.asymmetricPrivateKeyField=this.asymmetricValidateModal.querySelector("#private_key_validate_area"),this))},addListeners:function(){e.each(this.encryptionKeyOptions,function(e){e.addEventListener("change",this.toggleEncryptionType)}.bind(this)),this.symmetricKeyGenerator.addEventListener("click",this.generateSymmetricKey),this.asymmetricKeyGenerator.addEventListener("click",this.generateAsymmetricKey),this.symmetricKeyDownloader.addEventListener("click",this.enableSaveSettings),this.privateKeyDownloader.addEventListener("click",this.enableSaveSettings),this.asymmetricKeySelector.addEventListener("click",this.asymmetricPublicKeyValueToField),this.asymmetricKeyOpenValidateModal.addEventListener("click",this.validateAsymmetricKeysModal),this.asymmetricKeyDoValidation.addEventListener("click",this.validateAsymmetricKey),t(this.form).on("submit",function(e){this.ensureDownloadedKeys(e)}.bind(this)),t("body").on("thickbox:removed",this.cleanOnThickBoxClosing)},init:function(){this.toggleEncryptionType({target:this.currentOption()}),this.addListeners()}};window.addEventListener("load",(function(){var e=Object.create(l,{TYPE_ASYMMETRIC:n("asymmetric"),TYPE_SYMMETRIC:n("symmetric")});e.construct()&&e.init()}))}(window._,window.jQuery,window.tb_remove,window.ajaxurl,window.settingsEncryptionVariables);